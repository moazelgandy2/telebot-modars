generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BotSetting {
  key   String @id
  value String
}

model ChatSession {
  id        String        @id @default(uuid())
  userId    String        @unique
  username  String?
  messages  ChatMessage[]
  summary   String?
  metadata  Json?         @default("{}")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model ChatMessage {
  id          String       @id @default(uuid())
  role        String // "user" | "model"
  content     String
  sessionId   String
  session     ChatSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  attachments Attachment[]
  createdAt   DateTime     @default(now())
}

model Attachment {
  id        String      @id @default(uuid())
  url       String
  type      String // "image", "video", "document", etc.
  messageId String
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model SystemInstruction {
  id        String   @id @default(uuid())
  role      String   @default("system")
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FAQ {
  id        String   @id @default(uuid())
  question  String
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id        String    @id @default(uuid())
  userId    String    @unique // The specific ID used for checking
  name      String? // Optional name
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  startDate DateTime  @default(now())
  endDate   DateTime?
}

model Broadcast {
  id          String   @id @default(uuid())
  message     String
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  recipients  Json? // Optional: Store specific list of userIds if needed, otherwise all active subs.
  sentCount   Int      @default(0)
  failedCount Int      @default(0)
  log         Json? // Detailed log of failures
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ScheduledBroadcast {
  id        String    @id @default(uuid())
  message   String
  time      String // "HH:MM" 24-hour format
  isActive  Boolean   @default(true)
  lastRunAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Admin {
  id          String   @id @default(uuid())
  userId      String   @unique // Telegram User ID
  name        String?
  role        String   @default("ADMIN")
  permissions String[]
  createdAt   DateTime @default(now())
}

model PendingResponse {
  id           String   @id @default(uuid())
  userId       String
  message      String
  replyToMsgId Int?
  scheduledFor DateTime
  status       String   @default("PENDING") // PENDING, SENT, FAILED
  typingStatus Boolean  @default(false) // Whether typing has Been triggered
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([scheduledFor])
  @@index([status])
}
